# HyperLiquid DEX 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 产品定位

基于 HyperLiquid BuildCode 模式的第三方去中心化交易所（DEX）前端，提供永续合约和现货交易功能。

### 1.2 商业模式

- **收益来源**：通过 BuildCode 机制获取用户交易手续费分成
- **费率上限**：永续合约 0.1%，现货交易 1%
- **前置条件**：Builder 地址需在 HyperLiquid 永续账户中存入 100+ USDC

### 1.3 目标用户

- 加密货币交易者
- 寻求低延迟交易体验的用户
- 熟悉 HyperLiquid 生态的用户

### 1.4 参考产品

- **HyperLiquid**：底层交易协议
- **Based.one**：同类 BuildCode 产品

---

## 2. 功能模块

### 2.1 功能优先级总览

| 优先级 | 模块         | 说明            |
| ------ | ------------ | --------------- |
| **P0** | 永续合约交易 | 核心交易功能    |
| **P0** | 现货交易     | 核心交易功能    |
| **P0** | 钱包集成     | 用户认证和签名  |
| **P1** | 投资组合     | 资产和订单管理  |
| **P1** | Vault        | 资金池功能      |
| **P2** | 高级功能     | API钱包、设置等 |

---

## 3. P0 功能详情

### 3.1 永续合约交易

#### 3.1.1 行情展示

| 功能     | 描述                             | 数据源             |
| -------- | -------------------------------- | ------------------ |
| 价格头部 | 当前价格、24h涨跌幅、24h成交量   | `metaAndAssetCtxs` |
| K线图表  | TradingView 专业图表，支持多周期 | `candle` WebSocket |
| 订单簿   | 买卖盘深度，实时更新             | `l2Book` WebSocket |
| 最近成交 | 实时成交记录                     | `trades` WebSocket |

#### 3.1.2 下单功能

| 订单类型 | 参数                 | 说明             |
| -------- | -------------------- | ---------------- |
| 市价单   | 数量                 | IOC 立即成交     |
| 限价单   | 价格、数量           | GTC 挂单等待成交 |
| 止损单   | 触发价、执行价、数量 | 条件触发         |
| 止盈单   | 触发价、执行价、数量 | 条件触发         |

**下单参数**：

- 方向：买入/做多、卖出/做空
- 保证金模式：全仓 (Cross)、逐仓 (Isolated)
- 杠杆倍数：1x - 50x（根据资产不同）
- 时间有效性：GTC、IOC、FOK
- 只减仓：可选

#### 3.1.3 持仓管理

| 功能     | 描述                             |
| -------- | -------------------------------- |
| 持仓列表 | 显示当前所有持仓                 |
| 持仓信息 | 开仓价、数量、未实现盈亏、清算价 |
| 平仓操作 | 市价平仓、限价平仓               |
| 止损止盈 | 为持仓设置 TP/SL                 |

#### 3.1.4 订单管理

| 功能     | 描述               |
| -------- | ------------------ |
| 当前挂单 | 显示所有未成交订单 |
| 修改订单 | 修改价格、数量     |
| 取消订单 | 单个取消、全部取消 |
| 订单历史 | 查看历史订单记录   |

---

### 3.2 现货交易

#### 3.2.1 与永续合约的区别

| 项目     | 永续合约 | 现货          |
| -------- | -------- | ------------- |
| 杠杆     | 支持     | 不支持        |
| 做空     | 支持     | 不支持        |
| 资金费率 | 有       | 无            |
| 清算风险 | 有       | 无            |
| 资产 ID  | index    | 10000 + index |

#### 3.2.2 功能列表

- 现货买卖下单
- 订单簿展示
- K线图表
- 余额显示
- 订单管理

---

### 3.3 钱包集成

#### 3.3.1 支持的钱包

- MetaMask
- WalletConnect 兼容钱包
- Coinbase Wallet
- 其他 EVM 钱包

#### 3.3.2 连接流程

```
1. 用户点击"连接钱包"
2. 弹出钱包选择器（@reown/appkit）
3. 用户选择并授权连接
4. 检查 Builder 费率授权状态
5. 如未授权，提示用户签署 ApproveBuilderFee
6. 连接完成，显示用户信息
```

#### 3.3.3 签名操作

| 操作         | 签名方法                | 说明     |
| ------------ | ----------------------- | -------- |
| 下单         | sign_l1_action          | 交易操作 |
| 取消订单     | sign_l1_action          | 交易操作 |
| 授权 Builder | sign_user_signed_action | 用户授权 |

---

## 4. P1 功能详情

### 4.1 投资组合 (Portfolio)

#### 4.1.1 余额概览

| 显示项     | 描述               | 数据源                                          |
| ---------- | ------------------ | ----------------------------------------------- |
| 账户总值   | 永续 + 现货总价值  | `clearinghouseState` + `spotClearinghouseState` |
| 可用余额   | 可用于开仓的资金   | `withdrawable`                                  |
| 已用保证金 | 当前持仓占用       | `marginUsed`                                    |
| 未实现盈亏 | 所有持仓的浮盈浮亏 | `unrealizedPnl`                                 |

#### 4.1.2 持仓列表

- 永续持仓列表
- 现货余额列表
- 盈亏图表
- 资金变动历史

#### 4.1.3 订单历史

- 历史订单记录
- 成交记录
- 资金费率历史

---

### 4.2 Vault 功能

#### 4.2.1 Vault 列表

| 显示项     | 描述                  |
| ---------- | --------------------- |
| Vault 名称 | 资金池名称            |
| 管理者     | Vault 管理地址        |
| TVL        | 总锁定价值            |
| APY        | 年化收益率            |
| 用户份额   | 用户在该 Vault 的份额 |

#### 4.2.2 操作

| 操作     | 描述                  | API             |
| -------- | --------------------- | --------------- |
| 存入     | 向 Vault 存入资金     | `vaultDeposit`  |
| 取出     | 从 Vault 取出资金     | `vaultWithdraw` |
| 查看详情 | 查看 Vault 持仓和历史 | `vaultDetails`  |

---

## 5. P2 功能详情

### 5.1 API 钱包

- 创建子账户用于自动化交易
- 设置 API 钱包权限
- 管理 API 钱包列表

### 5.2 设置

- 主题切换（深色/浅色）
- 语言设置
- 通知设置
- 滑点设置

### 5.3 移动端适配

- 响应式布局优化
- 触摸交互优化
- 简化的移动端界面

---

## 6. 用户故事

### 6.1 新用户首次使用

```
作为一个新用户
我想要连接我的钱包并开始交易
以便我可以在这个 DEX 上进行永续合约交易

验收标准：
1. 我可以看到"连接钱包"按钮
2. 点击后弹出钱包选择器
3. 选择钱包后完成连接
4. 系统提示我授权 Builder 费用
5. 签名后显示我的账户信息
```

### 6.2 查看行情

```
作为一个交易者
我想要查看 BTC 永续合约的实时行情
以便我可以做出交易决策

验收标准：
1. 我可以看到 BTC 的当前价格
2. K线图实时更新
3. 订单簿显示买卖深度
4. 最近成交记录实时刷新
```

### 6.3 下限价单

```
作为一个交易者
我想要以指定价格买入 BTC
以便我可以在期望的价格建仓

验收标准：
1. 我可以选择"限价单"类型
2. 输入价格和数量
3. 选择杠杆倍数
4. 点击"买入/做多"
5. 钱包弹出签名请求
6. 签名后订单出现在"当前挂单"中
```

### 6.4 平仓

```
作为一个持仓用户
我想要平掉我的 BTC 多单
以便我可以锁定利润或止损

验收标准：
1. 在持仓列表中找到我的 BTC 持仓
2. 点击"平仓"按钮
3. 选择市价或限价平仓
4. 确认数量
5. 签名后持仓被平掉
```

### 6.5 Vault 存入

```
作为一个投资者
我想要将资金存入某个 Vault
以便我可以获得被动收益

验收标准：
1. 在 Vault 列表中选择目标 Vault
2. 查看 Vault 详情（APY、TVL 等）
3. 输入存入金额
4. 签名确认
5. 存入成功，显示我的份额
```

---

## 7. 非功能性需求

### 7.1 性能要求

| 指标               | 要求    |
| ------------------ | ------- |
| 页面加载时间       | < 3秒   |
| 订单簿更新延迟     | < 500ms |
| 下单响应时间       | < 2秒   |
| WebSocket 重连时间 | < 5秒   |

### 7.2 兼容性

| 项目   | 要求                                          |
| ------ | --------------------------------------------- |
| 浏览器 | Chrome 90+, Firefox 88+, Safari 14+, Edge 90+ |
| 设备   | 桌面优先，支持平板和手机                      |
| 分辨率 | 最小 1280x720，推荐 1920x1080                 |

### 7.3 安全性

- 所有交易需用户签名确认
- 不存储用户私钥
- 使用 HTTPS 和 WSS 加密通信
- 前端不处理敏感数据

### 7.4 可用性

- 支持键盘快捷键
- 清晰的错误提示
- 操作确认弹窗
- 加载状态指示

---

## 8. 现有组件映射

| 功能       | 现有组件               | 状态     | 需要改造          |
| ---------- | ---------------------- | -------- | ----------------- |
| 价格头部   | `PriceBar.tsx`         | 静态     | 接入 API          |
| K线图表    | `TradingViewChart.tsx` | Mock数据 | 接入 WebSocket    |
| 订单簿     | `OrderBook.tsx`        | Mock数据 | 接入 WebSocket    |
| 下单表单   | `TradeForm.tsx`        | 静态     | 接入签名和 API    |
| 账户面板   | `AccountPanel.tsx`     | 静态     | 接入 API          |
| 账户侧边栏 | `AccountSidebar.tsx`   | 静态     | 接入 API          |
| 钱包连接   | `Web3Provider.tsx`     | 已配置   | 添加 Builder 授权 |

---

## 9. 里程碑

### Phase 1：核心交易（P0）

- 钱包连接 + Builder 授权
- 永续合约行情展示
- 永续合约下单功能
- 持仓和订单管理

### Phase 2：扩展交易

- 现货交易功能
- 止损止盈订单
- 订单修改功能

### Phase 3：资产管理（P1）

- 投资组合页面
- Vault 功能

### Phase 4：高级功能（P2）

- API 钱包
- 设置页面
- 移动端优化
